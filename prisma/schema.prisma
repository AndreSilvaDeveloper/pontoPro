generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Empresa {
  id                  String      @id @default(cuid())
  nome                String
  cnpj                String?
  criadoEm            DateTime    @default(now())
  configuracoes       Json?
  status              String      @default("ATIVO")
  intervaloPago       Boolean     @default(false)
  fluxoEstrito        Boolean     @default(true)
  matrizId            String?
  chavePix            String?     @default("118.544.546-33")
  diaVencimento       Int         @default(15)
  dataUltimoPagamento DateTime?
  adminsPermitidos    AdminLoja[]
  matriz              Empresa?    @relation("MatrizFilial", fields: [matrizId], references: [id], onDelete: Restrict, onUpdate: NoAction)
  filiais             Empresa[]   @relation("MatrizFilial")
  feriados            Feriado[]
  usuarios            Usuario[]
}

model Usuario {
  id                 String              @id @default(cuid())
  nome               String
  email              String              @unique
  senha              String
  tituloCargo        String?
  fotoPerfilUrl      String?
  jornada            Json?
  assinaturaUrl      String?
  cargo              String              @default("FUNCIONARIO")
  deveTrocarSenha    Boolean             @default(false)
  empresaId          String?
  latitudeBase       Float               @default(0)
  longitudeBase      Float               @default(0)
  raioPermitido      Int                 @default(100)
  pontoLivre         Boolean             @default(false)
  locaisAdicionais   Json?
  criadoEm           DateTime            @default(now())
  resetToken         String?             @unique
  resetTokenExpiry   DateTime?
  ipsPermitidos      String?
  modoValidacaoPonto String              @default("GPS")
  lojasPermitidas    AdminLoja[]
  ausencias          Ausencia[]
  pontos             Ponto[]
  solicitacoes       SolicitacaoAjuste[]
  empresa            Empresa?            @relation(fields: [empresaId], references: [id])
}

model AdminLoja {
  id        String  @id @default(cuid())
  usuarioId String
  empresaId String
  empresa   Empresa @relation(fields: [empresaId], references: [id])
  usuario   Usuario @relation(fields: [usuarioId], references: [id])

  @@unique([usuarioId, empresaId])
}

model Ponto {
  id           String              @id @default(cuid())
  dataHora     DateTime            @default(now())
  latitude     Float
  longitude    Float
  endereco     String?
  fotoUrl      String?
  tipo         String              @default("NORMAL")
  subTipo      String?
  descricao    String?
  usuarioId    String
  usuario      Usuario             @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  solicitacoes SolicitacaoAjuste[]
}

model SolicitacaoAjuste {
  id          String   @id @default(cuid())
  novoHorario DateTime
  motivo      String
  status      String   @default("PENDENTE")
  tipo        String?
  usuarioId   String
  pontoId     String?
  criadoEm    DateTime @default(now())
  ponto       Ponto?   @relation(fields: [pontoId], references: [id], onDelete: Cascade)
  usuario     Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  decididoPorId   String?
  decididoPorNome String?
  decididoEm      DateTime?

}

model Ausencia {
  id             String   @id @default(cuid())
  dataInicio     DateTime
  dataFim        DateTime
  tipo           String
  motivo         String
  comprovanteUrl String?
  status         String   @default("PENDENTE")
  usuarioId      String
  criadoEm       DateTime @default(now())
  usuario        Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
}

model Feriado {
  id        String   @id @default(cuid())
  data      DateTime
  nome      String
  empresaId String?
  criadoEm  DateTime @default(now())
  empresa   Empresa? @relation(fields: [empresaId], references: [id])
}

model LogAuditoria {
  id        String   @id @default(cuid())
  dataHora  DateTime @default(now())
  acao      String
  detalhes  String
  adminNome String
  adminId   String
  empresaId String
}

enum ModoValidacaoPonto {
  GPS
  PC_IP
}
